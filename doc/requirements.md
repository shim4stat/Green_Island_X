# 要件定義書：個人の CO₂ 削減を価値化する階層型 DAO システム

※この文書は AI にコーディングさせるために作成しています。要件定義書としてチーム内の合意を得ているものではありません。

## 1. プロジェクト・コンセプト

### 1.1 ビジョン

「個人の努力 → デジタル資産 → 企業の脱炭素」へ変換する新しいエコシステムの構築。
日常生活での小さな CO₂ 削減活動（省エネ、移動手段の変更など）を、ブロックチェーン技術を用いて可視化・資産化し、最終的に企業が活用できる価値（ボランタリークレジット）へと昇華させる。

### 1.2 エコシステム構成（階層型 DAO）

- **Meta DAO（管理層）：** 全体を統括し、NFT 発行のルールやマーケット連携を管理する。
- **Sub DAO（実行層）：** 具体的な削減テーマごとに結成されるコミュニティ。
  - _例 1：パナソニック製省エネ家電 DAO_
  - _例 2：高齢者 × 歩行 DAO_
- **NFT（資産）：** Sub DAO そのものが 1 つの NFT（ERC721）として表現される。最初は未完成（削減量 0%）だが、メンバーの活動により成長し、1t（100%）達成で完成する。

---

## 2. MVP 開発スコープ

本デモアプリ（MVP）では、エコシステムの核となる**「Sub DAO のライフサイクル」**と**「スケーラビリティ（分割）」**の実装・検証に集中する。

1.  **DAO/NFT 作成：** 起案者がテーマを設定し、成長する NFT を作成する。
2.  **参加と貢献：** ユーザーが参加し、日々の削減活動を記録する。
3.  **DAO の分割（重要）：** 参加者が増えた際、DAO を細胞分裂のように分割し、拡大させる。
4.  **達成と完成：** 目標削減量に到達した際のステータス変化（Dynamic NFT）。

---

## 3. システムアーキテクチャ・技術スタック

### 3.1 技術スタック

- **Blockchain:** Ethereum Testnet (Sepolia)
- **Smart Contract:**
  - **Framework:** **Foundry** (Forge / Cast / Anvil)
  - **Language:** Solidity 0.8.x
- **Frontend:**
  - **Framework:** Next.js (React)
  - **Library:** **ethers.js v6**
  - **UI Component:** Tailwind CSS (推奨)
- **Storage:** IPFS (Pinata 等) - NFT メタデータ（JSON）および画像

### 3.2 データモデル概要

[Image of decentralized autonomous organization structure diagram]

- **SubDAO NFT:** `ERC721` 規格を継承・拡張。各 `tokenId` が 1 つの SubDAO に対応。
- **Contribution:** `mapping(uint256 => mapping(address => uint256))` で「DAO ごと・ユーザーごと」の削減量（グラム）を管理。

---

## 4. 機能要件詳細

### 4.1 SubDAO 作成機能（起案者）

- **概要:** どんな方法で CO₂ を削減するかを定義し、NFT を発行する。
- **入力項目:**
  - Title（DAO 名）
  - Description（ストーリー・削減方法）
  - Target Amount（目標削減量、**単位：グラム** ※例: 1000kg = 1,000,000g）
  - Image URI 1（成長前/未達成時の画像）
  - Image URI 2（完成時/達成時の画像）
- **処理:**
  - 新規 `tokenId` を Mint。
  - メタデータ URI として「未達成時」のものをセット。
  - 起案者を DAO の管理者（Admin）として登録。

### 4.2 参加・トラッキング機能（一般メンバー）

- **参加 (Join):** ウォレット接続し、特定の SubDAO に参加表明（メンバーリスト配列に追加）。
- **活動記録 (Track):**
  - **入力:** ユーザーが削減行動（歩数、省エネ行動等）を入力し、相当する CO₂ 量（グラム）を送信。
    - _※MVP 制約: 不正チェックは行わず、ユーザーの自己申告入力をそのまま信頼して記録する。_
  - **計算:** `currentAmount += inputAmount`
  - **貢献度更新:** 個人の累積貢献量を加算。

### 4.3 DAO 分割機能（スケーラビリティ）

DAO が肥大化（メンバー過多）した際に、効率維持のために組織を分割する機能。

- **トリガー:**
  - メンバー数が閾値（例: 50 人）を超えた場合、または管理者（起案者）の手動実行。
- **分割ロジック:**
  1.  **Clone:** 親 DAO と同じメタデータ（タイトル・目標値・画像）を持つ「新しい `tokenId`」を発行。
  2.  **Inherit:** 親 DAO の管理者を、新 DAO の管理者として設定（※MVP では同一人物が管理する）。
  3.  **Reset:** 新 DAO は「削減量 0」「メンバーは管理者のみ」のクリーンな状態で開始。
  4.  **Link:** 新 DAO の構造体に `parentId` を記録し、系譜（Genealogy）を追跡可能にする。

### 4.4 達成・可視化機能（Dynamic NFT）

- **可視化:** フロントエンドにて `currentAmount / targetAmount` の進捗率(%)を表示。
- **達成 (Complete):**
  - `currentAmount >= targetAmount` となったトランザクション内で自動実行。
  - **状態変更:** `isCompleted = true`
  - **メタデータ更新:** `tokenURI` を「完成時（Image URI 2）」のものに差し替える、またはオンチェーンで Base64 エンコードされたメタデータを動的に返す。
  - **イベント発火:** `DAOCompleted(tokenId)` イベントを発行し、フロントエンドで祝福エフェクトを表示。

---

## 5. UI/UX イメージ（Frontend）

1.  **Dashboard（Top）:**
    - 全ての SubDAO をカード形式で一覧表示（フィルタ：募集中 / 達成済み）。
    - 進捗バーとパーセンテージ（例: 45%）の表示。
2.  **DAO Detail（詳細）:**
    - DAO のストーリーと現在の画像（未達成/達成で変化）。
    - **「活動を記録する」**フォーム（数値入力 + 送信ボタン）。
    - 貢献者ランキング（Leaderboard）。
    - **「DAO を分割する」**ボタン（条件達成時のみ活性化、管理者にのみ表示）。
3.  **Create DAO（作成）:**
    - 起案用フォーム。画像の IPFS アップロード機能（または URL 直打ち）。
4.  **My Page:**
    - 参加中の DAO 一覧と、自分の総貢献量（g）表示。

---

## 6. 技術的制約・留意事項（MVP）

- **数値精度:** Solidity での計算精度を保つため、内部計算はすべて整数（グラム単位）で行い、フロントエンド表示時に ` / 1000` して kg 表示にする。
- **信頼性:** 本 MVP では「入力された削減値」の真偽判定（Oracle 連携等）はスコープ外とする。
- **ガス代:** 記録（Track）のたびにガス代が発生するため、テストネット（Sepolia）での利用を前提とする。
